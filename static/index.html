<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="icon" type="image/png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="author" content="Enrique Coronado" />
    <!--   //TODO: media need internet, change a to local value: 'https://blockly-demo.appspot.com/static/media/', : in workspace.js -->

	<title>Rize</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <meta name="viewport" content="width=device-width" />

     <!-- ################# Rize library  ######################## -->
     <script src="rize/rize.js"></script>
     <script script type="text/javascript" src="rize/primitives.js"></script>
     <script script type="text/javascript" src="rize/modals.js"></script>



    <!-- ################# Google Blockly realted stuff  ######################## -->

    <!-- In develpment mode use the next line, if not then comment it -->
    <script src="web_libraries/blockly/blockly_uncompressed.js"></script>
    <!-- In internet mode better uncomment the next line -->
    <!-- <script src="web_libraries/blockly/blockly_compressed.js"></script> -->
    <script src="web_libraries/blockly/blocks/behaviors.js"></script>
    <script src="web_libraries/blockly/blocks/primitives.js"></script>

    <!-- We need to run build.py in order to add our blocks, this are saved in this script -->
    <script src="web_libraries/blockly/blocks_compressed.js"></script>

    <!-- This define the lenguage, in this case English -->
    <script src="web_libraries/blockly/msg/js/en.js"></script>

    <!-- Here the code generation scripts are added for each programming lenguage used -->
    <script src="web_libraries/blockly/python_compressed.js"></script>

    <!-- Navigation bar (nav-bar) files -->
    <script src="web_libraries/nav-bar/prefixfree.min.js"></script>


    <!--  ************************ Toolbox **************************** -->
    <script type="text/javascript" src="rize/dropdown.js"></script>
    <script type="text/javascript" src="rize/toolbox.js"></script>
        
        
    <!-- ************** Blockly Workspace definition ***************** -->
    <script src="rize/workspace.js"></script>
   

    <!--  ##################################  CSS files ##################################  -->
    <!-- Awesome font -->
    <link rel="stylesheet" href="web_libraries/font-awesome-4.7.0/css/font-awesome.min.css">
    <!-- Link the CSS boostap library -->
    <link rel="stylesheet" type="text/css" href="web_libraries/bootstrap-3.3.7/css/bootstrap.min.css" />
    <!-- My navigation bar design -->
    <link href="rize/design.css" rel="stylesheet"/>

    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,100,500,300italic,500italic,700italic,900,300">


    <!--  ################################## Javascript files ##################################  -->
    <!-- Link the JQuery library -->
    <script type="text/javascript" src="web_libraries/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="web_libraries/json2html/json2html.js"></script>
    <script type="text/javascript" src="web_libraries/json2html/jquery.json2html.js"></script>

    <!-- Link the JS boostrap library -->
    <script type="text/javascript" src="web_libraries/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="web_libraries/js-interpreter/acorn_interpreter.js"></script>
    
    
    <!-- ************************  Nice allert library: sweetalert2 **************** -->
    <script src="web_libraries/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <!-- Include a polyfill for ES6 Promises (optional) for IE11 and Android browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>


    <!-- ************************  JSON **************** -->
    <script type="text/javascript" src="rize/databases.js"></script>

    <!-- ************************   epoch **************** -->

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Nova+Flat" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Comfortaa" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Nunito" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Quicksand" />
    
    
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

        <!--JQuery--> 
    
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
 

    <!--<script src="web_libraries/epoch/dist/js/epoch.js"></script>
    <link rel="stylesheet" type="text/css" href="web_libraries/epoch/dist/css/epoch.min.css">

    <script>
            var nextTime = (function() {
                var currentTime = parseInt(new Date().getTime() / 1000);
                return function() { return currentTime++; }
            })();
        </script> -->



</head>

<body>

    <!-- <div id="test-3" class="test">
        <div class="epoch"></div>
        <div class="play_button">
                <p><button>Play</button></p>
        </div>
    </div>


    <script>
    $(function() {
        var data = [{ label: 'A', values: [] }],
            length = 40,
            nextIndex = length,
            playing = false,
            interval = null;

        for (var i = 0; i < length; i++) {
            var x = i * 2 * Math.PI / length,
                y = Math.cos(x) + 1,
                time = nextTime();
            data[0].values.push({time: time, y: y});
        }

        var chart = $('#test-3 .epoch').epoch({
            type: 'time.line',
            data: data
        });

        var pushPoint = function() {
            var x = nextIndex * 2 * Math.PI / length,
                y = Math.cos(x) + 1,
                time = nextTime();
            chart.push([{ time: time, y: y}]);
            nextIndex++;
        };

        $('#test-3 button').on('click', function(e) {
            if (playing) {
                $(e.target).text('Play');
                clearInterval(interval);
            }
            else {
                $(e.target).text('Pause');
                pushPoint();
                interval = setInterval(pushPoint, 1000);
            }
            playing = !playing;
        });
    });
    </script> -->


            <div id="my_right_sidenav" class="right_sidenav">
                <a href="javascript:void(0)" class="closebtn" onclick="rize.closeNav()">&times;</a>

                <h4 style="margin-left: 35px">Online</h4>

                <div style="width:120px; float:left; text-align:center;">
                        <img src="rize/images/robot.png" style="width: 60px;height: 60px;" />
                        <br/>
                        <span>  nao </span>
                </div>

                <div style="width:120px; float:left; text-align:center;">
                        <img src="rize/images/robot.png" style="width: 60px;height: 60px;" />
                        <br/>
                        <span>  nao </span>
                </div>


                
                <div style="width:120px; float:left; text-align:center;">
                        <img src="rize/images/robot.png" style="width: 60px;height: 60px;" />
                        <br/>
                        <span>  nao </span>
                </div>

              </div>
              


    <div id="mySidenav" class="sidenav">
        <ul class="drawer">
            <li> <a href="#"  onclick="rize.onNewProject();return false;" > <i class="fa fa-file-o"></i> <span>New</span> </a> </li>
            <li> <a href="#"  onclick="rize.onLoadProject();return false;"> <i class="fa fa-folder-open-o"></i> <span>Load</span> </a> </li>
            <li> <a href="#"  onclick="rize.onSaveProject();return false;"> <i class="fa fa-save"></i> <span>Save</span> </a> </li>
            <li> <a href="#"  onclick="rize.connect_openNav();return false;"> <i class="fa fa-wifi"></i> <span>Connect</span> </a> </li>
            <li> <a href="#" > <i class="fa fa-heart-o "></i> <span>Simulator</span> </a> </li>
            <li> <a href="#"  onclick="rize.onSeeCode();return false;" > <i class="fa fa-code"></i> <span>See code</span> </a> </li>
            <li> <a href="#"  onclick="rize.openNav()"> <i class="fa fa-area-chart"></i> <span>Monitor</span> </a> </li>
            <li> <a href="#"> <i class="fa fa-cog"></i> <span>Configuration</span> </a></li>
          

          
          
            <li> <a href="#"> <i class="fa fa-question-circle"></i> <span>Help</span> </a>
              <ul>
                <li> <a href="#" onclick="rize.button_openNav()"> <i class="fa fa-puzzle-piece"></i> <span>Blocks</span> </a> </li>
                <li> <a href="#"> <i class="fa fa-question"></i> <span>General</span> </a> </li>
                <li> <a href="#"> <i class="fa fa-code"></i> <span>Developer</span> </a> </li>
                <li> <a href="#"> <i class="fa fa-info"></i> <span>About</span> </a> </li>
              </ul>
            </li>
          </ul>
    </div>
      
    <div id="main">

       
        <div><p></p>&nbsp; </div>
        <div class ="buttons">
            
                            <!-- space -->
                            &nbsp;
                            <!-- **************** BUTTON:  NEW **************** 
                            <button type="button" onclick="onNewWorkspace()"  data-balloon="New program" data-balloon-pos="down"  class="btn btn-default btn-circle btn-lg"  ><i class="fa fa-file-o"></i>
                            </button>
                           
                            &nbsp;  &nbsp; -->
                            <span> 
                            <!-- **************** BUTTON:  Undo **************** -->
                            <button type="button" onclick="rize.doUndo()" data-balloon="Undo" data-balloon-pos="down"  class="btn btn-info btn-circle btn-lg" ><i class="fa fa-undo"></i>
                            </button>
                            </span>
                            &nbsp;  &nbsp; 
                            <!-- **************** BUTTON:  Redo **************** -->
                            <button type="button" onclick="rize.doRedo()" data-balloon="Redo" data-balloon-pos="down"  class="btn btn-info btn-circle btn-lg"   ><i class="fa fa-rotate-right"></i>
                            </button>
                  
                            &nbsp;  &nbsp; 
                            <button type="button" data-balloon="Run program" data-balloon-pos="down" onclick="rize.onRunCode()" class="btn btn-primary btn-circle btn-lg"   ><i class="fa fa-play"></i>
                            </button>
                           
                           &nbsp;  &nbsp; 
                           <button type="button" data-balloon="Stop program" data-balloon-pos="down" onclick="rize.onStopCode()" class="btn btn-primary btn-circle btn-lg"    ><i class="fa fa-stop"></i>
                           </button>

                           &nbsp;  &nbsp; 

                         <!-- ************ BUTTON: HELP ************** -->
                         <button type="button"   onclick="rize.button_openNav()"   data-balloon="Help" data-balloon-pos="down" class="btn btn-success btn-circle btn-lg" ><i class="fa fa-question"></i>
                         </button>
                         <!--  <button type="button" onclick="onNewWorkspace()" class="btn btn-danger btn-lg"><span class="btn-label"><i class="fa fa-trash-o"></i></span> Clear</button> -->
                         &nbsp;  &nbsp; 

                           <img src="rize/images/tuat.png" alt="Mountain View" style="height:42px;"  align="right">

        </div>

        <div id="blocklyArea">
        <div id="blocklyDiv" style="position: absolute">
        </div><p></p>&nbsp; </div>
        </div>

        <div id="my_button_sidenav" class="button_sidenav">
                <button type="button"  onclick="rize.button_closeNav()" class="btn btn-primary btn-circle btn-ch" ><i class="fa fa-close"></i>
                </button>
            <div class = "blocks_svg">
                <p> Select one block </p>
            </div>
        </div>

        
        <div id="code_sidenav" class="code_sidenav">
            <button type="button"  onclick="rize.code_closeNav()" class="btn btn-primary btn-circle btn-ch" ><i class="fa fa-close"></i>
            </button>
        <div class = "show_code">
            <p> Python code </p>
        </div>
    </div>


        <div id="connect_sidenav" class="connect_sidenav">

                <div class="modal-header">
                        <button type="button" class="close" onclick="rize.connect_closeNav()" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Define the robot to connect</h4>
                    </div>
                    <div class="modal-body">
                    <div class="form-group">
                        <label>Put a name to your robot:</label>
                        <input class="form-control" id = "name_robot">
                        <p class="help-block">Example: John </p>
                    </div>
          
                    <label>Select the type of robot</label>
                        <select class="form-control" id = "type_robot_simple">
                            <option>nao</option>
                            <option>pepper</option>
                            <option>other</option>
                        </select>
                                                            
                                                                        
                    <div class="form-group">
                        <label>Select the first numbers of the IP address of the robot:</label>
                        <select class="form-control" id = "ip_robot_simple">
                            <option>192.168.0.</option>
                            <option>192.168.1.</option>
                            <option>192.168.11.</option>
                            <option>127.0.0.</option>
                        </select>
                    </div>
          
                    <div class="form-group">
                        <label>Write the last number of the IP address:</label>
                            <input class="form-control" id = "last_ip_simple">
                            <p class="help-block">Example: 21 </p>
                    </div>
          
                    <label>Press the button to connect the robot:</label>  &nbsp;  
                    <!-- Button to connect the robot -->
                    <div>
                    <button type="button" class="btn btn-info btn-lg" style=" margin-left:80px; float:center; text-align:center;" onclick="rize.onConnectRobot()" data-dismiss="modal" >Connect</i> </button>
                    </div>                                                     
          
 
        </div>


        <div id="primitive_sidenav" class="primitive_sidenav">
                <div class = "primitive_modal">
                        <p> Select one primitive </p>
                </div>
        </div>


        
        <div id="load_sidenav" class="load_sidenav">
                
                            <div class="modal-header">
                                <button type="button" class="close" onclick="rize.load_closeNav()" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Load a project</h4>
                            </div>
                            <div class="modal-body"> 
                            <div>
                            <label>Select a project:</label>
                            <select id = "project_load" class="project_selector" size="10">
                                <option value="1">One</option>
                            </select>
                            </div>
                            <label>Press the button to load:</label>  &nbsp;  
                            <div class="button_load">
                                <!-- **************** BUTTON:  LOAD **************** -->
                                <button type="button"  onclick=" rize.onLoad()"   class="btn btn-warning btn-lg" style=" margin-left:55px; float:center; text-align:center;" >Load</i>
                                </button>
                            </div>
                            <div>
                                    &nbsp;  
                            </div>
                            <h4 class="modal-title">Recover auto-save</h4>
                            &nbsp;  
                            <label>Press the button to recover from the last change:</label>  &nbsp; 

                                <!-- **************** BUTTON:  LOAD **************** -->
                                <button type="button"  onclick=" rize.onRecover()"   class="btn btn-info btn-lg " style=" margin-left:40px; float:center; text-align:center;" >Recover</i>
                                </button>
                            </div>
                                
                 
        </div>



</body>
<script>
  
  
  // ......... Global variables ................
  
  var input_robots={"options": [["nao", "nao"], ["pepper", "pepper"]]}
  // This value must have the same value that in the server
  var url_var = "http://127.0.0.1:5000/new_action";
  
  var default_robot_name = "default";
  var default_robot_ip = "192.168.11.100";
  var default_robot_type = "nao";
  var blocks; //Used to save the xml code of the main workspace (program of the user)
  var default_code = '# -*- encoding: UTF-8 -*-' + '\n' + 'import time' + '\n' + 'from nep import*' + '\n' + '\n' + 'r = interaction()' + '\n' 

  // Images in blocks
  var configuration_image = "rize/images/edit.png"
  var play_image = "rize/images/play.png"

  Blockly.Msg.LISTS_CREATE_WITH_INPUT_WITH = 'list';


var play_event =  function () {
next_blocks = block_selected.getNextBlock();
full_code_block = Blockly.Python.blockToCode(block_selected);
code_to_delete = Blockly.Python.blockToCode(next_blocks);
specific_block_code = full_code_block.replace(code_to_delete,'')
var code = default_code + specific_block_code
// See the code in the console (for example the Chorme console)
console.log(code);
// Action to do by the server
var json = {"action":"run", "input":code}
            console.log(JSON.stringify(json));
            $.ajax({
                    type : "POST",
                    url : url_var,
                    contentType: "application/json; charset=utf-8",
                    data : JSON.stringify(json),
                    dataType : "json"
                });
}

/*
var  edit_set_voice_language = function () {
console.log("event");
}


var edit_set_voice_speed = function () {
console.log("event");
}


var edit_human_gesture =  function () {
console.log("event");
}*/



// Event that is launched when the edit button in a primitive is selected
var edit_primitive = function () {
    rize.onCloseAll()

    //Get current primitive info from database
    current_primitive =  database[block_selected.type];
    // Create modal
    html_code = primitives.onGetHTML(current_primitive,block_selected.type);
    $('.primitive_modal').html(html_code);


    var options = block_selected.getFieldValue("inp_2");
    document.getElementById("main_input").value = block_selected.getFieldValue("inp_1")
    if (options == "edit")
    {
        console.log("No options")
    }
    else{
        let options2fill = JSON.parse(options)
        if (current_primitive.hasOwnProperty('options'))
        {
            let optionblocks = current_primitive.options;
            let keys = Object.keys(options2fill);

            for(var i=0;i<keys.length;i++){
                var key = keys[i];
                if(optionblocks[key] == "bool")
                {
                    document.getElementById("option_"+key).checked = options2fill[key];
                }
                else{
                    document.getElementById("option_"+key).value = options2fill[key];
                }
            }
        }
    }



    // Open modal
    rize.primitive_openNav();
}

function getOptionsfromBlock(options)
{
    let lista = options.split(" ");
    for(var i=0;i<lista.length;i++){
    let values = lista[i].split(":");

    }
}


    /*const {value: input_value} = await swal({
    title: 'Values',
    input: 'select',
    inputOptions: input_animation,
    inputPlaceholder: 'Select a value',
    showCancelButton: true,
    inputValidator: (value) => {
        return new Promise((resolve) => {
        if (value === '') {
            resolve('You need to select a value :)')
        } else {
            resolve()
        }
        })
    }
    })

    if (input_value) {
    swal('You selected: ' + input_value)
    }
    console.log("animation:" +  block_selected);
    block_selected.setFieldValue(input_value, "inp_1");*/



/*
var edit_imitation =  function () {
rize.primitive_openNav(html_imitation)
input_imitation = block_selected.getFieldValue("inp_1");
//console.log(input_imitation);
options_imitation = block_selected.getFieldValue("inp_1");

//console.log(options_imitation);
//block_selected.setFieldValue(input_imitation, "inp_1");

}

var  edit_gesture  =  function () {
console.log("event");
}

var  edit_say  =  function () {
console.log("event");
}


var edit_human_emotion = async function () {
    
    console.log("event");
};*/


  
  var blocklyArea = document.getElementById('blocklyArea');
  var blocklyDiv = document.getElementById('blocklyDiv');
  var WORKSPACE = Blockly.inject('blocklyDiv', options);
  var onresize = function(e) {
    // Compute the absolute coordinates and dimensions of blocklyArea.
    var element = blocklyArea;
    var x = 0;
    var y = 0;
    do {
      x += element.offsetLeft;
      y += element.offsetTop;
      element = element.offsetParent;
    } while (element);
    // Position blocklyDiv over blocklyArea.
    blocklyDiv.style.left = x + 'px';
    blocklyDiv.style.top = y + 'px';
    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
  };
  window.addEventListener('resize', onresize, false);
  onresize();
  Blockly.svgResize(WORKSPACE);



 // var WORKSPACE = Blockly.inject('blocklyDiv', options);
  WORKSPACE.addChangeListener(blockEvent);

  var current_project_defined = false;
  var project_name = "";  
  var save_next_move = false;
  var block_selected = "";
  var current_primitive; 


  function blockEvent(masterEvent) {

    // To select the block properties we can use json["newValue"] (for ui in element== "selected") or json["blockId"] (for create and move)
    rize.onCloseAll()
    // Convert event to JSON.  This could then be transmitted across the net.
    var json = masterEvent.toJson();
    console.log(json);
    console.log(masterEvent.type)

    if (masterEvent.type == "ui"){
        save_next_move =  true;

        if (masterEvent.element == "selected")
        {
            if (json["newValue"] != null)
            {

                block_selected = WORKSPACE.getBlockById(json["newValue"])
                console.log(block_selected);
            }
        }
 

    
    }

    if (masterEvent.type == "move"){

        if (save_next_move == true)
        {
            rize.onAutoSaveProject()
        }
        save_next_move =  false;
    }

    //console.log(json["blockId"]);
    if  (json["blockId"] != null)
    {
        blockx = WORKSPACE.getBlockById(json["blockId"])
        console.log(blockx.type)
        //console.log(blockx.helpUrl)
        //console.log(blockx.tooltip)
        //console.log(block.inputList[0])
        //console.log(block.inputList[0].fieldRow[1].textElement_)



        //TODO: separates blocks, it shows also the parents
        var svgObject  = blockx.getSvgRoot() //Get svg image of the block selected
        svgStringData = $(svgObject).html() // Transfrom svg to string
        var html  = '<p >';
        html += blockx.tooltip;
        html += '</p>' ;
        html += '<svg width="600" height="200"> <g transform = "translate(10,10)">';
        html += svgStringData // Put the image in a svg html form
        html += " </g> </svg>";
        $('.blocks_svg').html(html); // Add the html code in the .svg class (in a div)

        
    }

    onresize();
    Blockly.svgResize(WORKSPACE);


  }

 
// Notas: blockly changes:  ---------------- NO borarr ----------------------

// -- files: 
// -- block_render_svg.js,  block_svg.js, css.js
//  Blockly.FieldImage.prototype.EDITABLE = true; in field_image.js

// ************************ SSE *****************************
$(document).ready(
    function() {
        sse = new EventSource('/my_event_source');
        sse.onmessage = function(message) {
        
            if (message.data != 'null')
        {
          console.log(message.data);
          var json_event = jQuery.parseJSON( message.data );

          if(json_event.node_type == "action")
          
          {
              if(json_event.node_status == "connection_starting")
              {
                var temp_robot_name = json_event.robot_name
                swal({
                title: "Connectig " + temp_robot_name + " !",
                text: " Please wait few a moment",
                showConfirmButton: false,
                });

              }
              
              if (json_event.node_status == "connection_ready")
              {
                var temp_robot_name = json_event.robot_name
                //onAddRobot(temp_robot_name)
                swal("Robot " +  temp_robot_name + " connected" , "", "success");
              }

              if (json_event.node_status == "connection_error")
              {
                var temp_robot_name = json_event.robot_name
                swal({
                title: "Robot " + temp_robot_name + " was not able to connect",
                text: "Possible solutions: \n 1.- Are your robot and your computer in the same wifi connection? \n 2.- Did you select the correct IP addres of your robot? ",
                imageUrl: "static/interface/images/no_wifi.png"});
            }

              if (json_event.node_status == "connection_closed")
              {
                var temp_robot_name = json_event.robot_name
                swal({
                title: "Connection with "+ temp_robot_name +  " was closed",
                text: "Robot is offline, did you want to reconnect it? ",
                imageUrl: "static/interface/images/no_wifi.png"});

              }
          

            if(json_event.node_type == "main_code")
            {
                if (json_event.node_status == "execution_busy")
                {
                    var temp_robot_name = json_event.robot_name
                    swal("Another program is already in execution" , "You can use the stop button to close the execution of the another program", "error")
                }
            }

        }
      }
      
        
        }

    }
)



$(window).resize(function() {
    //These 2 functions are used to resize the workspace
    onresize();
    Blockly.svgResize(WORKSPACE);

});

        
  </script>
</html>

